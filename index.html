<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Navigator | Hybrid Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --paper: #fdfaf0; --ink: #2c3e50; --accent: #2980b9; --green: #27ae60; --red: #e74c3c; --orange: #e67e22; --gray: #95a5a6; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #222; overflow: hidden; }

        /* --- OVERLAYS --- */
        #lock-screen, #mode-selection {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--ink); z-index: 10000; display: flex; align-items: center; justify-content: center; color: white;
        }
        #mode-selection { background: #1a252f; z-index: 9999; display: none; }
        
        .box { background: #34495e; padding: 30px; border-radius: 15px; text-align: center; width: 85%; max-width: 400px; box-shadow: 0 10px 50px rgba(0,0,0,0.5); }
        .box h2 { margin-top: 0; }
        .box input { width: 100%; padding: 15px; font-size: 18px; text-align: center; border-radius: 8px; border: none; margin: 15px 0; box-sizing: border-box;}
        
        .mode-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .mode-btn { background: var(--accent); padding: 20px; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        .mode-btn:hover { background: var(--green); transform: translateY(-5px); }
        .mode-btn i { font-size: 30px; display: block; margin-bottom: 10px; }

        /* --- BASIC LAYOUT --- */
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; background: #333; }
        #sidebar { 
            position: absolute; background: white; padding: 15px; border-radius: 12px; 
            z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.4); 
            display: flex; flex-direction: column; transition: all 0.4s ease;
        }

        /* --- DESKTOP MODE --- */
        body.mode-desktop #sidebar {
            top: 20px; left: 20px; bottom: 20px; width: 360px;
        }

        /* --- MOBILE MODE --- */
        body.mode-mobile #sidebar {
            top: auto; left: 10px; right: 10px; bottom: 10px; height: 50%;
            width: auto; border-radius: 15px 15px 12px 12px;
        }
        body.mode-mobile .history-section { display: none; }

        /* --- UI ELEMENTS --- */
        .input-section { flex-grow: 1; overflow-y: auto; }
        input, textarea, button, select { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-save { background: var(--green); height: 45px; }
        .project-tools { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .dist-badge { background: var(--ink); color: white; padding: 6px; border-radius: 4px; font-size: 12px; font-weight: bold; text-align: center; }
        .preview-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 8px; }
        .preview-item { position: relative; aspect-ratio: 1; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .chronik-item { background: #f4f4f4; padding: 10px; margin-top: 8px; border-radius: 5px; border-left: 4px solid var(--accent); font-size: 12px; }

        @media print { #sidebar, #lock-screen, #mode-selection { display: none !important; } }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="box">
        <h2>üîí Logbuch-Key</h2>
        <input type="password" id="appKeyInput" placeholder="Sicherheitscode" inputmode="numeric">
        <button onclick="unlockApp()" style="background:var(--green)">Best√§tigen</button>
    </div>
</div>

<div id="mode-selection">
    <div class="box">
        <h2>üì± Modus w√§hlen</h2>
        <p>Wie m√∂chtest du das Tool nutzen?</p>
        <div class="mode-btn-grid">
            <div class="mode-btn" onclick="setMode('desktop')">
                <span>üíª</span><br>Desktop
            </div>
            <div class="mode-btn" onclick="setMode('mobile')">
                <span>üì±</span><br>Mobil
            </div>
        </div>
    </div>
</div>

<div id="sidebar">
    <div class="input-section">
        <div class="project-tools">
            <button onclick="newProject()" style="background:var(--red); font-size:11px">‚ú® Neu</button>
            <button onclick="exportProject()" style="background:var(--orange); font-size:11px">üíæ Exp</button>
            <button onclick="document.getElementById('importFile').click()" style="background:var(--ink); font-size:11px">üìÇ Imp</button>
            <input type="file" id="importFile" style="display:none" accept=".json" onchange="importProject(this)">
        </div>
        
        <input type="text" id="tripTitle" placeholder="Reise-Name">
        <select id="travelMode" onchange="updateRoute(false)">
            <option value="pkw">üöó PKW Route</option>
            <option value="schiff" selected>‚õµ Schiff nm</option>
            <option value="flugzeug">‚úàÔ∏è Flugzeug</option>
        </select>
        <div id="distDisplay" class="dist-badge">Wegpunkte setzen...</div>
        <input type="date" id="tDate">
        <input type="text" id="routeName" placeholder="Etappe (z.B. Tag 1)">
        <textarea id="diary" style="height: 50px;" placeholder="Was ist passiert?"></textarea>
        
        <button onclick="document.getElementById('imgIn').click()" style="background:#7f8c8d; margin-top:10px;">üì∑ Bilder hinzuf√ºgen</button>
        <input type="file" id="imgIn" style="display:none" multiple accept="image/*" onchange="processImages(this.files)">
        
        <div id="preview-grid" class="preview-grid"></div>
        
        <button id="saveBtn" class="btn-save" onclick="saveEntry()" disabled style="margin-top:15px">üìå Etappe speichern</button>
        <button onclick="prepareNext()" style="background:#34495e; margin-top:8px;">‚è≠Ô∏è N√§chste Etappe</button>
        <button onclick="handleExport()" style="background:#2c3e50; margin-top:8px;">üìñ PDF Reisebericht</button>
        
        <div class="history-section" id="chronik-list"></div>
    </div>
</div>

<div id="map"></div>
<div id="print-area"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
    const APP_KEY = "1234";
    let map, markers = [], routeLine, currentImages = [], db, currentDistKM = 0, currentDistNM = 0;

    // --- INITIALISIERUNG & MODUS ---
    function unlockApp() {
        if(document.getElementById('appKeyInput').value === APP_KEY) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('mode-selection').style.display = 'flex';
        } else { alert("Falscher Key!"); }
    }

    function setMode(mode) {
        document.body.className = 'mode-' + mode;
        document.getElementById('mode-selection').style.display = 'none';
        initMap();
    }

    function initMap() {
        map = L.map('map', { zoomControl: true }).setView([50.11, 8.68], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { crossOrigin: 'anonymous' }).addTo(map);

        // PC Rechtsklick
        map.on('contextmenu', e => addMarker(e.latlng)); 
        
        // Mobile Long-Press (Gedr√ºckt halten)
        let pressTimer;
        map.on('mousedown touchstart', e => {
            pressTimer = window.setTimeout(() => { if(e.latlng) addMarker(e.latlng); }, 800);
        });
        map.on('mouseup touchend mousemove touchmove', () => clearTimeout(pressTimer));
    }

    // --- DATENBANK ---
    const request = indexedDB.open("TravelLogDB_v11", 1);
    request.onsuccess = e => { db = e.target.result; renderHistoryList(); };
    request.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore("entries", { keyPath: "id", autoIncrement: true });
    };

    // --- LOGIK ---
    function addMarker(latlng) {
        const m = L.marker(latlng, { draggable: true }).addTo(map);
        m.on('dragend', () => updateRoute(false));
        m.on('click contextmenu', e => {
            if(e.type === 'contextmenu' || e.originalEvent.ctrlKey) {
                map.removeLayer(m);
                markers = markers.filter(x => x !== m);
                updateRoute(false);
            }
        });
        markers.push(m);
        updateRoute(false);
    }

    async function updateRoute(autoZoom = false) {
        if (routeLine) map.removeLayer(routeLine);
        if (markers.length < 2) { document.getElementById('saveBtn').disabled = true; return; }
        
        const coords = markers.map(m => m.getLatLng());
        const mode = document.getElementById('travelMode').value;

        if (mode === "pkw") {
            const query = coords.map(c => `${c.lng},${c.lat}`).join(';');
            try {
                const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${query}?geometries=geojson&overview=full`);
                const data = await response.json();
                const routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                routeLine = L.polyline(routeCoords, { color: '#e67e22', weight: 5 }).addTo(map);
                currentDistKM = (data.routes[0].distance / 1000).toFixed(2);
                document.getElementById('distDisplay').innerText = `PKW: ${currentDistKM} km`;
            } catch (err) { drawDirect(coords, mode); }
        } else { drawDirect(coords, mode); }
        document.getElementById('saveBtn').disabled = false;
        if (autoZoom && routeLine) map.fitBounds(routeLine.getBounds().pad(0.2));
    }

    function drawDirect(coords, mode) {
        let meters = 0;
        for (let i=0; i<coords.length-1; i++) meters += L.latLng(coords[i]).distanceTo(L.latLng(coords[i+1]));
        currentDistKM = (meters/1000).toFixed(2);
        currentDistNM = (meters/1852).toFixed(2);
        const plane = mode === "flugzeug";
        routeLine = L.polyline(coords, { color: plane ? '#9b59b6' : '#2980b9', weight: 4, dashArray: plane ? "10,15" : "" }).addTo(map);
        document.getElementById('distDisplay').innerText = mode === "schiff" ? `${currentDistNM} nm` : `${currentDistKM} km`;
    }

    function processImages(files) {
        Array.from(files).forEach(file => {
            const r = new FileReader();
            r.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const max = 800; let w = img.width, h = img.height;
                    if (w > h && w > max) { h *= max/w; w = max; } else if (h > max) { w *= max/h; h = max; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    currentImages.push(canvas.toDataURL('image/jpeg', 0.6));
                    renderPreviews();
                };
                img.src = e.target.result;
            };
            r.readAsDataURL(file);
        });
    }

    function renderPreviews() {
        document.getElementById('preview-grid').innerHTML = currentImages.map(src => `<div class="preview-item"><img src="${src}"></div>`).join('');
    }

    async function saveEntry() {
        const btn = document.getElementById('saveBtn');
        btn.innerText = "‚è≥ Snapshot..."; btn.disabled = true;
        if (routeLine) map.fitBounds(routeLine.getBounds().pad(0.2));
        await new Promise(r => setTimeout(r, 1000));
        const canvas = await html2canvas(document.getElementById('map'), { useCORS: true });
        const entry = {
            date: document.getElementById('tDate').value,
            name: document.getElementById('routeName').value || "Etappe",
            text: document.getElementById('diary').value,
            mode: document.getElementById('travelMode').value,
            distKM: currentDistKM, distNM: currentDistNM,
            images: [...currentImages],
            mapImg: canvas.toDataURL("image/jpeg", 0.6)
        };
        const tx = db.transaction("entries", "readwrite");
        tx.objectStore("entries").add(entry);
        tx.oncomplete = () => { renderHistoryList(); btn.innerText = "üìå Gespeichert"; btn.disabled = false; };
    }

    function renderHistoryList() {
        const list = document.getElementById('chronik-list'); if(!list) return;
        list.innerHTML = '<strong>Chronik:</strong>';
        const tx = db.transaction("entries", "readonly");
        tx.objectStore("entries").getAll().onsuccess = e => {
            e.target.result.forEach(entry => {
                const d = document.createElement('div'); d.className = 'chronik-item';
                d.innerHTML = `<b>${entry.name}</b> (${entry.date})`;
                list.appendChild(d);
            });
        };
    }

    function newProject() { if(confirm("Alles l√∂schen?")) { const tx = db.transaction("entries", "readwrite"); tx.objectStore("entries").clear(); tx.oncomplete = () => location.reload(); }}
    function exportProject() { const tx = db.transaction("entries", "readonly"); tx.objectStore("entries").getAll().onsuccess = e => { const data = { title: document.getElementById('tripTitle').value, entries: e.target.result }; const blob = new Blob([JSON.stringify(data)], { type: "application/json" }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "Reise.json"; a.click(); }; }
    function importProject(input) { const r = new FileReader(); r.onload = e => { const data = JSON.parse(e.target.result); const tx = db.transaction("entries", "readwrite"); const store = tx.objectStore("entries"); data.entries.forEach(en => { delete en.id; store.add(en); }); tx.oncomplete = () => location.reload(); }; r.readAsText(input.files[0]); }
    function prepareNext() { markers.forEach(m => map.removeLayer(m)); markers = []; if(routeLine) map.removeLayer(routeLine); currentImages = []; renderPreviews(); document.getElementById('saveBtn').disabled = true; }
    function handleExport() { 
        const tx = db.transaction("entries", "readonly");
        tx.objectStore("entries").getAll().onsuccess = e => {
            let html = `<h1>${document.getElementById('tripTitle').value}</h1>`;
            e.target.result.forEach(en => {
                html += `<div style="page-break-after:always"><h2>${en.name}</h2><img src="${en.mapImg}" style="width:100%"><p>${en.text}</p></div>`;
            });
            document.getElementById('print-area').innerHTML = html;
            window.print();
        };
    }
</script>
</body>
</html>