<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Navigator | Final Route Fix</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --ink: #2c3e50; --accent: #2980b9; --green: #27ae60; --red: #e74c3c; --orange: #e67e22; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background: #222; overflow: hidden; }
        #lock-screen, #mode-selection { position: fixed; inset: 0; background: var(--ink); z-index: 10000; display: flex; align-items: center; justify-content: center; color: white; }
        #mode-selection { display: none; }
        .box { background: #34495e; padding: 25px; border-radius: 12px; text-align: center; width: 80%; max-width: 350px; }
        #map { position: absolute; inset: 0; z-index: 1; }
        #sidebar { position: absolute; top: 10px; left: 10px; bottom: 10px; width: 320px; background: white; padding: 15px; border-radius: 10px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; overflow-y: auto; }
        input, textarea, button, select { width: 100%; padding: 10px; margin-top: 8px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; }
        .project-tools { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .chronik-item { background: #eee; padding: 10px; margin-top: 8px; border-radius: 5px; border-left: 4px solid var(--accent); cursor: pointer; font-size: 13px; }
        .dist-badge { background: var(--ink); color: white; padding: 8px; border-radius: 4px; font-size: 12px; text-align: center; margin-top: 10px; }
        
        @media (max-width: 600px) {
            #sidebar { width: auto; inset: auto 10px 10px 10px; height: 45%; }
        }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="box">
        <h2>ðŸ”’ Key</h2>
        <input type="password" id="appKeyInput" placeholder="Code (1234)" inputmode="numeric">
        <button onclick="unlockApp()" style="background:var(--green)">Login</button>
    </div>
</div>

<div id="mode-selection">
    <div class="box">
        <h2>ðŸ“± Modus</h2>
        <button onclick="setMode('desktop')">Laptop/PC</button>
        <button onclick="setMode('mobile')" style="margin-top:10px">Smartphone</button>
    </div>
</div>

<div id="sidebar">
    <div class="project-tools">
        <button onclick="newProject()" style="background:var(--red)">âœ¨ Neu</button>
        <button onclick="exportProject()" style="background:var(--orange)">ðŸ’¾ Exp</button>
        <button onclick="document.getElementById('importFile').click()" style="background:var(--ink)">ðŸ“‚ Imp</button>
        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importProject(this)">
    </div>
    <input type="text" id="tripTitle" placeholder="Reisetitel">
    <div id="distDisplay" class="dist-badge">0.00 km</div>
    <input type="date" id="tDate">
    <input type="text" id="routeName" placeholder="Etappenname">
    <textarea id="diary" placeholder="Notizen..."></textarea>
    <button onclick="saveEntry()" style="background:var(--green); margin-top:10px">ðŸ“Œ Etappe speichern</button>
    <div id="chronik-list" style="margin-top:15px"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const KEY = "1234";
    let map, markers = [], routeLine, db;

    function unlockApp() {
        if(document.getElementById('appKeyInput').value === KEY) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('mode-selection').style.display = 'flex';
        } else { alert("Falsch!"); }
    }

    function setMode(m) {
        document.getElementById('mode-selection').style.display = 'none';
        initMap();
    }

    function initMap() {
        map = L.map('map').setView([50, 10], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        map.on('contextmenu', e => addMarker(e.latlng));
        
        let pressTimer;
        map.on('mousedown touchstart', e => { pressTimer = window.setTimeout(() => { if(e.latlng) addMarker(e.latlng); }, 600); });
        map.on('mouseup touchend', () => clearTimeout(pressTimer));
        
        initDB();
    }

    function initDB() {
        const req = indexedDB.open("NavFix_v26", 1);
        req.onupgradeneeded = e => { e.target.result.createObjectStore("etappen", { keyPath: "id", autoIncrement: true }); };
        req.onsuccess = e => { db = e.target.result; renderList(); };
    }

    function addMarker(latlng) {
        const m = L.marker(latlng, { draggable: true }).addTo(map);
        m.on('dragend', updateRoute);
        markers.push(m);
        updateRoute();
    }

    function updateRoute() {
        if (routeLine) map.removeLayer(routeLine);
        const coords = markers.map(m => m.getLatLng());
        if (coords.length >= 2) {
            routeLine = L.polyline(coords, { color: '#2980b9', weight: 5 }).addTo(map);
            let d = 0;
            for(let i=0; i<coords.length-1; i++) d += coords[i].distanceTo(coords[i+1]);
            document.getElementById('distDisplay').innerText = (d/1000).toFixed(2) + " km";
        }
    }

    function saveEntry() {
        if(markers.length === 0) return alert("Punkte setzen!");
        const entry = {
            name: document.getElementById('routeName').value || "Etappe",
            date: document.getElementById('tDate').value,
            text: document.getElementById('diary').value,
            points: markers.map(m => [m.getLatLng().lat, m.getLatLng().lng]) // Speichert LÃ¤ngen- und Breitengrad
        };
        const tx = db.transaction("etappen", "readwrite");
        tx.objectStore("etappen").add(entry);
        tx.oncomplete = () => { resetUI(); renderList(); };
    }

    function resetUI() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        if(routeLine) map.removeLayer(routeLine);
        document.getElementById('routeName').value = "";
        document.getElementById('diary').value = "";
    }

    function renderList() {
        const list = document.getElementById('chronik-list');
        list.innerHTML = "<b>Verlauf:</b>";
        db.transaction("etappen", "readonly").objectStore("etappen").getAll().onsuccess = e => {
            e.target.result.forEach(en => {
                const item = document.createElement('div');
                item.className = 'chronik-item';
                item.innerHTML = `<strong>${en.name}</strong><br><small>${en.date}</small>`;
                item.onclick = () => loadEtappe(en);
                list.appendChild(item);
            });
        };
    }

    function loadEtappe(en) {
        resetUI();
        if(!en.points || en.points.length === 0) return;
        
        // Marker wiederherstellen
        en.points.forEach(p => {
            const m = L.marker(p, { draggable: true }).addTo(map);
            m.on('dragend', updateRoute);
            markers.push(m);
        });
        
        updateRoute(); // Zeichnet die Linie
        
        // Karte auf Route zentrieren
        if(routeLine) map.fitBounds(routeLine.getBounds(), { padding: [30, 30] });
        
        // Texte fÃ¼llen
        document.getElementById('routeName').value = en.name;
        document.getElementById('diary').value = en.text;
        document.getElementById('tDate').value = en.date;
    }

    function exportProject() {
        db.transaction("etappen", "readonly").objectStore("etappen").getAll().onsuccess = e => {
            const blob = new Blob([JSON.stringify({entries: e.target.result})], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "Reisebericht.json";
            a.click();
        };
    }

    function importProject(input) {
        const reader = new FileReader();
        reader.onload = e => {
            const data = JSON.parse(e.target.result);
            const tx = db.transaction("etappen", "readwrite");
            const store = tx.objectStore("etappen");
            store.clear(); // LÃ¶scht alte Daten beim Import
            data.entries.forEach(en => { delete en.id; store.add(en); });
            tx.oncomplete = () => { renderList(); alert("Geladen! Klicke eine Etappe im Verlauf an."); };
        };
        reader.readAsText(input.files[0]);
    }

    function newProject() { if(confirm("App zurÃ¼cksetzen?")) { db.transaction("etappen", "readwrite").objectStore("etappen").clear().oncomplete = () => location.reload(); }}
</script>
</body>
</html>
